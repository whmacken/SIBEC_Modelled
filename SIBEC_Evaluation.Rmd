---
title: "SIBEC_Evaluation"
author: "William H MacKenzie"
date: "29/11/2019"
output:
  pdf_document: default
  html_document: default
---
# Evaluation of SIBEC values
This script was built to look at the range of site index by site series or other site factors for the SIBEC dataset compiled by Atticus from the original data sets.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tinytex.verbose = TRUE)
require(tidyverse)
require(TeachingDemos)
require (ggplot2)
require (assertr)
require(data.table)
require(tinytex)
require(DBI)
library(purrr)
```

##Import Vtrees data

Read in SIBEC data from a .csv table export of a _Trees table from the VTrees database

```{r Vtrees data import}
sibec_master <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/OneDrive - Government of BC/SIBEC_files/SIBEC_2024_Prov_VPRO_Master.accdb;")
sibec  <- dbReadTable(sibec_master, "SIBEC_All_2024_ENV")
sibec.tree  <- dbReadTable(sibec_master, "SIBEC_All_2024_Trees")
sibec.info  <- dbReadTable(sibec_master, "SIBEC_All_2024_TreePlot")
#SI_raw  <- dbReadTable(sibec_master, "SIBEC_Analysis_Data")
dbDisconnect(sibec_master)
xx <- unique(sibec.tree$TreeSpp)
sibec.anal <- merge(sibec.tree, sibec.info, by = c("PlotNumber")) 
sibec.anal <- merge(sibec.anal, sibec, by = c("PlotNumber")) %>% mutate(BGC = sub("/.*", "", BECSiteUnit)) %>%
  select(PlotNumber, TreeSpp, TreeNum, CountAge, TotalHtCalc, BGC, BECSiteUnit, MoistureRegime, NutrientRegime, Latitude, Longitude, Elevation, SiteIndex25_interior, SiteIndex25_coast, SiteIndex24)
sibec.anal <- sibec.anal %>% mutate(rSNRg = ifelse(NutrientRegime %in% c("A", "B"), "P",
                                            ifelse(NutrientRegime %in% c("D", "E"), "R",
                                                 ifelse (NutrientRegime %in% c("C"), "PM", "other"))))
sibec.anal <- sibec.anal %>% mutate(eda1 = paste0(MoistureRegime, rSNRg))

fwrite(sibec.anal, "./data/SIBEC_Analysis_data_2025.csv")
```


```{r export for SiteTools}
# sibec.tree$TreeSpp <- sibec.tree$TreeSpp %>% recode(
#   "Sw" = "Sx", "sw" = "Sx", "Se" = "Sx", "SX" = "Sx", "HW" = "Hw",
#   "EP"= "Ep", "FD" = "Fd", "Fd " = "Fd", "PL" = "Pl")
# SI_clean <-  sibec.tree %>% select(PlotNumber,TreeSpp, TreeNum, CountAge, TotalHtCalc) %>% dplyr::rename(Species = TreeSpp, `BHAge` = CountAge, `Height` = TotalHtCalc ) %>% mutate(PlotNumber= paste0("SI_",PlotNumber))
# write.csv(SI_clean, "./for_sitetools/SIBEC_2024_ForSiteTools_v2.csv", row.names = FALSE)

```

## Generate boxplots of site index by site series with phases
This produces a facetted boxplot graph for each species in a BGC showing site index by site series

```{r boxplot species by rSMR}
SI_spp <- sibec.anal %>% order(BGC)#%>% filter(grepl("^SBSmc2", BECSiteUnit))
SI_spp <- drop_na (SI_spp)
# Create separate plots for each BGC
unique_bgcs <- sort(unique(SI_spp$BGC))
bgc = "BGxh1"
for (bgc in unique_bgcs) {
  # Filter data for the current BGC
  SI_spp_subset <- SI_spp %>% filter(BGC == bgc)
  
  # Create the plot
ggplot(SI_spp_subset, aes(x=eda1, y=SiteIndex25_interior, fill=rSNRg)) +
  geom_boxplot() +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray80")
  ) +
  ggtitle(paste0("Site Index by edaphic position ", bgc)) +
  facet_wrap(~TreeSpp)
  #plot(SI_plot)
  # Save the plot
  ggsave(filename = paste0("./outputs/SiteIndex_", bgc, "_rSMR.png"), plot = SI_plot, width = 8, height = 6)
}

```

```{r boxplot SS phases graphs, fig.width = 12, fig.height = 8, fig.cap = "Fig. 1 Site Index by Site Series with phases - removed some outliers for each species in the SBSmc2" }

remove <-c("SBC3727", "SBC3724", "SBC3711", "SBC3712", "SBC3686", "SBC7318", "SBC3109", "SBC3108","SBC3422",
            "SBC6092", "SBC3716", "SBC3714", "SBC6145" ) # these are 12 plots with much higher productivity than the second set (2 phases?)
SI_spp1 <- SI_spp [!(SI_spp$PlotNumber %in% remove), ]
table(SI_spp1[, "SiteSeries"])

SI_spp1$SiteSeries <- as.factor(SI_spp1$SiteSeries)

##box blot of site index by site series for selected zone
#sets order for site series -- need to make this more universal
SI_spp1$SiteSeries <- factor(SI_spp1$SiteSeries, levels = c("02", "03", "01c", "01b", "01a", "01",#
                                                          "04", "05", "06", "09b","09", "09a", #
                                                           "10a","10", "07","10b","12"))# "12a",
#-------Produce boxplot
BGC = "SBSmc2"
SI_box1 <- ggplot(SI_spp1, aes(x=SiteSeries, y=SI_interior, fill=Species)) + 
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ggtitle(paste0 ("Site Index by Site Series phases for the "), BGC)+
  facet_wrap(~Species)
plot(SI_box1)

ggsave("SIxSSphase2_boxplot_SBSmc2ver2.jpg", SI_box1, device="jpeg", path = "./SI_prediction/outputs/")

```

## Generate boxplots of site index by site series without phases
This produces a facetted boxplot graph for each species in a BGC showing site index by site series

```{r boxplot SS graphs, fig.width = 12, fig.height = 8, fig.cap = "Fig. 2 Site Index by Site Series (no phases) for each species in the SBSmc2" }
### remove any phase designations
SI_spp1$SiteSeries <- as.character(SI_spp1$SiteSeries)
SI_spp2 <- SI_spp1 %>% 
      mutate(SiteSeries_rename = ifelse(SiteSeries %in% c('01a', '01b', '01c'), '01', 
                     ifelse(SiteSeries %in% c('09a', '09b'), '09',
                            ifelse (SiteSeries %in% c('10a','10b'), '10', SiteSeries))))
table(SI_spp2[, "SiteSeries_rename"])

#SI_spp2$SiteSeries_rename <- as.factor(SI_spp2$SiteSeries_rename)

##box blot of site index by site series for selected zone
#sets order for site series -- need to make this more universal
SI_spp2$SiteSeries_rename <- factor(SI_spp2$SiteSeries_rename, levels = c("02", "03",  "01",#"01c", "01b", "01a",
                                                          "04", "05", "06", "09", #"09b", "09a",
                                                           "10", "07","12"))#"10a","10b", "12a",
#-------Produce boxplot
BGC = "SBSmc2"
SI_box2 <- ggplot(SI_spp2, aes(x=SiteSeries_rename, y=SI_interior, fill=Species)) + 
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ggtitle(paste0 ("Site Index by Site Series (no phases) for the "), BGC)+
  facet_wrap(~Species)
plot(SI_box2)

ggsave("SIxSS_boxplot_SBSmc2ver2.jpg", SI_box2, device="jpeg", path = "./SI_prediction/outputs/")



```


## Generate boxplots of site index by soil moisture regime
This produces a facetted boxplot graph for each species in a BGC showing site index by site series

```{r boxplot SMR graphs, fig.width = 12, fig.height = 8, fig.cap = "Fig. 3 Site Index by SoilMoisture Regime for each species in the SBSmc2" }
#-------Produce boxplot
table(SI_spp[, "MoistureRegime"])
SI_spp$MoistureRegime <- as.factor(SI_spp$MoistureRegime)
SI_box3 <- ggplot(SI_spp, aes(x=MoistureRegime, y=SI_interior, fill=Species)) + 
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ggtitle(paste0 ("Site Index by SMR for the "), BGC)+
  facet_wrap(~Species)
plot(SI_box3)

ggsave("SIxEdatopeSMR_boxplot_SBSmc2ver2.jpg", SI_box3, device="jpeg", path = "./SI_prediction/outputs/")


```
## Generate Plots by Edatope organized by SMR groups

```{r boxplot edatopicxSMR graphs, fig.width = 12, fig.height = 8, fig.cap = "Fig. 4 Site Index by Edatope-SMR for each species in the SBSmc2" }
#-------Produce boxplot
table(SI_spp[, "edatope"])
SI_spp$edatope <- as.factor(SI_spp$edatope)
SI_box4 <- ggplot(SI_spp, aes(x=edatope, y=SI_interior, fill=Species)) + 
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ggtitle(paste0 ("Site Index by Edatope for the "), BGC)+
  facet_wrap(~Species)
plot(SI_box4)

ggsave("SIxEdatopeSMR_boxplot_SBSmc2ver2.jpg", SI_box4, device="jpeg", path = "./SI_prediction/outputs/")


```

## Generate Plots by Edatope organized by SNR groups
```{r boxplot edatopicxSNR graphs, fig.width = 12, fig.height = 8, fig.cap = "Fig. 5 Site Index by Edatope-SNR for each species in the SBSmc2" }
#-------Produce boxplot
table(SI_tidy[, "edatope2"])
SI_box5 <- ggplot(SI_spp, aes(x=edatope2, y=SI_interior, fill=Species)) + 
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ggtitle(paste0 ("Site Index by Edatope for the "), BGC)+
  facet_wrap(~Species)
plot(SI_box5)

ggsave("SIxEdatopeSNR_boxplot_SBSmc2ver2.jpg", SI_box5, device="jpeg", path = "./SI_prediction/outputs/")

```

